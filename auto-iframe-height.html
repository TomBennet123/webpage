<iframe id="autoH"
        src="/images/home/studentguide.html"
        style="width:100%; border:0; overflow:hidden; display:block;"
        scrolling="no">
</iframe>

<script>
  (function(){
    const iframe = document.getElementById('autoH');
    if (!iframe) {
      console.warn('[AutoHeight] iframe #autoH nem található.');
      return;
    }
    // biztos, hogy „szülő” domain = iframe domain
    const domainOK = true; // ha nem, itt lehetne ellenőrizni: iframe.src origin vs location.origin
    if (!domainOK) {
      console.warn('[AutoHeight] Domain mismatch, cannot access iframe contentDocument.');
      return;
    }

    // alap stílusbeállítások
    iframe.style.overflow = 'hidden';
    iframe.style.display  = 'block';

    // mérés funkció
    let rafId = null;
    function scheduleMeasure() {
      if (rafId !== null) {
        return;
      }
      rafId = requestAnimationFrame(() => {
        rafId = null;
        measure();
      });
    }

    function measure() {
      let height = 0;
      const prevInlineHeight = iframe.style.height;
      const prevRenderedHeight = iframe.offsetHeight;
      let scrollX = typeof window.scrollX === 'number' ? window.scrollX : window.pageXOffset || 0;
      let scrollY = typeof window.scrollY === 'number' ? window.scrollY : window.pageYOffset || 0;
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc) {
          console.warn('[AutoHeight] iframe document nem elérhető még.');
          return;
        }
        // ideiglenesen nullára állítjuk, hogy a mérésnél ne maradjon
        // a korábbi (esetleg túl magas) viewport érték.
        iframe.style.height = '0px';

        const h1 = doc.documentElement.scrollHeight;
        const h2 = doc.documentElement.offsetHeight;
        const h3 = doc.body?.scrollHeight || 0;
        const h4 = doc.body?.offsetHeight  || 0;
        const rectRoot = doc.documentElement.getBoundingClientRect();
        const rectBody = doc.body?.getBoundingClientRect();
        const h7 = Math.round(rectRoot?.height || 0);
        const h8 = Math.round(rectBody?.height || 0);
        const candidates = [h1, h2, h3, h4, h7, h8].filter(v => typeof v === 'number' && !Number.isNaN(v) && v >= 0);

        height = candidates.length ? Math.max(...candidates) : prevRenderedHeight;

        // visszaállítjuk a korábbi értéket, hogy csak akkor legyen új érték,
        // ha sikerült mérni.
        iframe.style.height = prevInlineHeight;

        console.debug('[AutoHeight] mérés-eredmények:', {
          scrollHeight: h1,
          offsetHeight: h2,
          bodyScrollHeight: h3,
          bodyOffsetHeight: h4,
          rectDocument: h7,
          rectBody: h8,
          chosen: height
        });
      } catch(e) {
        console.error('[AutoHeight] Hiba a mérés közben:', e);
        return;
      }

      const nextHeightPx = height + 'px';
      const heightChanged = !Number.isNaN(height) && Math.round(height) !== Math.round(prevRenderedHeight);
      iframe.style.height = nextHeightPx;
      if (heightChanged && (window.scrollX !== scrollX || window.scrollY !== scrollY) && typeof window.scrollTo === 'function') {
        window.scrollTo(scrollX, scrollY);
      }
      console.debug('[AutoHeight] iframe magasság állítva:', height + 'px');
    }

    // betöltés esemény
    iframe.addEventListener('load', () => {
      console.info('[AutoHeight] iframe betöltve, indul a automatikus magasság-mérés.');
      measure();

      // betűtípusok várása
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if (doc.fonts && doc.fonts.ready) {
          doc.fonts.ready.then(() => {
            console.debug('[AutoHeight] webfontok betöltve, újramérés.');
            measure();
          }).catch(() => {});
        }
      } catch(e){}

      // képek figyelése
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const imgs = Array.from(doc.images || []);
        imgs.forEach(img => {
          if (!img.complete) {
            img.addEventListener('load', scheduleMeasure, { passive:true });
            img.addEventListener('error', scheduleMeasure, { passive:true });
          }
        });
      } catch(e){}

      // ResizeObserver
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const ro = new ResizeObserver(scheduleMeasure);
        ro.observe(doc.documentElement);
      } catch(e){}

      // MutationObserver
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const mo = new MutationObserver(scheduleMeasure);
        mo.observe(doc.documentElement, { childList:true, subtree:true, attributes:true });
      } catch(e){}

      // transition/animation végén
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.addEventListener('transitionend', scheduleMeasure, { passive:true, capture:true });
        doc.addEventListener('animationend',  scheduleMeasure, { passive:true, capture:true });
        doc.addEventListener('toggle',        scheduleMeasure, { passive:true, capture:true });
        doc.addEventListener('click',         scheduleMeasure, { passive:true, capture:true });
        doc.addEventListener('keyup',         scheduleMeasure, { passive:true, capture:true });
      } catch(e){}

      // opcionális cleanup lehetőség
      iframe.cleanupAutoHeight = () => {
        console.info('[AutoHeight] leállítva.');
      };
    });

    // ha már betöltődött korábban
    if (iframe.contentDocument && iframe.contentDocument.readyState !== 'loading') {
      // közvetlenül hívjuk
      console.info('[AutoHeight] iframe már betöltve, közvetlen indítás.');
      iframe.dispatchEvent(new Event('load'));
    }

  })();
</script>
